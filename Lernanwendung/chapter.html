<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kapitel</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <div class="topbar">
        
        <div class="navWrap">
  <button class="burger" id="burgerBtn" type="button" aria-label="Menü öffnen">
    <div class="burgerIcon" aria-hidden="true">
      <span></span><span></span><span></span>
    </div>
  </button>

  <div class="menuPanel" id="menuPanel">
    <div class="menuHeader">
      <p class="t">Navigation</p>
    </div>
    <a class="menuItem" href="index.html"><span class="dot"></span>Startseite</a>
    <a class="menuItem" href="info.html"><span class="dot"></span>Projektinformation</a>
    <a class="menuItem" href="glossary.html"><span class="dot"></span>Fremdwörtererklärung</a>

  </div>
</div>

      <a class="badge" href="index.html">← Zur Startseite</a>
      <div class="badge" id="stateBadge">…</div>
    </div>

    <div class="panel">
      <h2 class="h2" id="title">…</h2>
      <p class="muted" id="blurb">…</p>

      <div class="videoWrap">
        <video id="video" controls preload="metadata"></video>
      </div>

      <div class="footerRow">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="markWatchedBtn" type="button">Als gesehen markieren (Test)</button>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn" href="index.html">Abbrechen</a>
          <button class="btn primary" id="toQuizBtn" type="button" disabled>Weiter zum Quiz</button>
        </div>
      </div>

      <p class="muted" style="margin-top:10px;">
        Hinweis: Der „Weiter“-Button wird automatisch aktiv, sobald das Video zu Ende ist. 
      </p>
    </div>
  </div>

  <script src="app.js"></script>
  <script src="content.js"></script>
  <script>
    const id = qs("id");
    const chapter = CONTENT.chapters.find(c => c.id === id);
    if (!chapter) location.href = "index.html";

    const st = getChapterState(id);

    document.title = chapter.title;
    document.getElementById("title").textContent = chapter.title;
    document.getElementById("blurb").textContent = chapter.blurb;

    const badge = document.getElementById("stateBadge");
    function updateBadge(){
      const s = getChapterState(id);
      badge.textContent = s.mastered ? "✓ Abgeschlossen (100%)" : `Best: ${s.bestScore || 0}%`;
    }
    updateBadge();

    const video = document.getElementById("video");
    const toQuizBtn = document.getElementById("toQuizBtn");

    // Videoquelle setzen (wenn vorhanden)
    if (chapter.videoSrc) {
      video.src = chapter.videoSrc;
    } else {
      // Kein Video eingebunden: Poster/Platzhalter
      video.removeAttribute("src");
    }

    function unlockQuiz(){
      patchChapterState(id, { watched: true });
      toQuizBtn.disabled = false;
      updateBadge();
    }

    // Gate: Video Ende
    video.addEventListener("ended", unlockQuiz);

    // Wenn bereits gesehen, direkt freischalten
    if (st.watched) {
      toQuizBtn.disabled = false;
    }

    document.getElementById("markWatchedBtn").addEventListener("click", unlockQuiz);

    toQuizBtn.addEventListener("click", () => {
      location.href = `quiz.html?id=${encodeURIComponent(id)}&mode=all`;
    });
    (function(){
    const btn = document.getElementById("burgerBtn");
    const panel = document.getElementById("menuPanel");
    if(!btn || !panel) return;

    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      panel.classList.toggle("open");
    });

    document.addEventListener("click", () => panel.classList.remove("open"));
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape") panel.classList.remove("open");
    });
  })();
  </script>
</body>
</html>
